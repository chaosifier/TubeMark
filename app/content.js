let svgString =
  '<svg height="100%" version="1.1" viewBox="-5 -13 60 60" width="100%"><g id="surface1"><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 20.84375 21.917969 L 26.460938 14.152344 C 26.632812 13.914062 26.609375 13.585938 26.398438 13.375 C 26.191406 13.167969 25.863281 13.140625 25.625 13.3125 L 17.855469 18.933594 C 17.347656 19.300781 17.03125 19.871094 16.980469 20.496094 C 16.933594 21.121094 17.160156 21.730469 17.601562 22.171875 C 18.007812 22.578125 18.542969 22.800781 19.113281 22.800781 C 19.796875 22.800781 20.441406 22.46875 20.84375 21.917969 Z M 20.84375 21.917969 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 32.71875 11.738281 C 32.714844 11.726562 32.714844 11.710938 32.707031 11.699219 C 32.699219 11.6875 32.6875 11.679688 32.679688 11.671875 C 32.074219 10.628906 31.355469 9.660156 30.542969 8.785156 L 31.832031 7.496094 L 32.679688 8.34375 L 35.222656 5.800781 L 32.679688 3.253906 L 30.132812 5.800781 L 30.980469 6.648438 L 29.695312 7.9375 C 28.816406 7.121094 27.847656 6.402344 26.808594 5.796875 C 26.796875 5.789062 26.789062 5.777344 26.777344 5.769531 C 26.765625 5.761719 26.753906 5.761719 26.738281 5.757812 C 24.882812 4.6875 22.800781 3.976562 20.578125 3.714844 L 20.578125 3 L 21.476562 3 C 22.304688 3 22.976562 2.328125 22.976562 1.5 C 22.976562 0.671875 22.304688 0 21.476562 0 L 16.074219 0 C 15.25 0 14.574219 0.671875 14.574219 1.5 C 14.574219 2.328125 15.25 3 16.074219 3 L 16.976562 3 L 16.976562 3.695312 C 16.328125 3.761719 15.679688 3.867188 15.042969 4.015625 C 14.71875 4.089844 14.515625 4.410156 14.589844 4.734375 C 14.664062 5.054688 14.988281 5.257812 15.308594 5.183594 C 15.878906 5.054688 16.449219 4.957031 17.027344 4.894531 L 17.621094 4.847656 C 17.820312 4.832031 18 4.820312 18.175781 4.8125 L 18.175781 6 C 18.175781 6.332031 18.445312 6.601562 18.773438 6.601562 C 19.105469 6.601562 19.375 6.332031 19.375 6 L 19.375 4.816406 C 21.632812 4.921875 23.757812 5.527344 25.648438 6.523438 L 25.058594 7.550781 C 24.890625 7.835938 24.988281 8.203125 25.277344 8.371094 C 25.371094 8.425781 25.472656 8.449219 25.578125 8.449219 C 25.785156 8.449219 25.984375 8.34375 26.097656 8.148438 L 26.6875 7.128906 C 28.5625 8.320312 30.160156 9.914062 31.347656 11.789062 L 30.328125 12.378906 C 30.042969 12.546875 29.945312 12.914062 30.109375 13.199219 C 30.222656 13.394531 30.421875 13.5 30.628906 13.5 C 30.730469 13.5 30.835938 13.472656 30.929688 13.417969 L 31.953125 12.828125 C 32.964844 14.746094 33.574219 16.90625 33.664062 19.199219 L 32.476562 19.199219 C 32.144531 19.199219 31.878906 19.46875 31.878906 19.800781 C 31.878906 20.132812 32.144531 20.398438 32.476562 20.398438 L 33.664062 20.398438 C 33.574219 22.691406 32.964844 24.851562 31.953125 26.769531 L 30.929688 26.179688 C 30.644531 26.011719 30.277344 26.109375 30.109375 26.398438 C 29.945312 26.6875 30.042969 27.054688 30.328125 27.21875 L 31.351562 27.808594 C 30.160156 29.6875 28.566406 31.28125 26.6875 32.472656 L 26.097656 31.449219 C 25.933594 31.160156 25.5625 31.0625 25.277344 31.230469 C 24.992188 31.394531 24.894531 31.761719 25.058594 32.050781 L 25.652344 33.074219 C 23.761719 34.070312 21.632812 34.675781 19.378906 34.78125 L 19.378906 33.601562 C 19.378906 33.269531 19.109375 33 18.777344 33 C 18.445312 33 18.175781 33.269531 18.175781 33.601562 L 18.175781 34.785156 C 17.21875 34.753906 16.257812 34.632812 15.3125 34.414062 C 14.988281 34.339844 14.667969 34.542969 14.59375 34.867188 C 14.519531 35.1875 14.71875 35.511719 15.042969 35.585938 C 16.242188 35.859375 17.464844 36 18.679688 36 C 18.707031 36 18.734375 36 18.765625 35.996094 C 18.769531 35.996094 18.773438 36 18.777344 36 C 18.78125 36 18.785156 35.996094 18.789062 35.996094 C 21.671875 35.976562 24.378906 35.199219 26.722656 33.851562 C 26.738281 33.84375 26.757812 33.839844 26.777344 33.828125 C 26.789062 33.824219 26.796875 33.8125 26.808594 33.804688 C 29.230469 32.390625 31.253906 30.367188 32.671875 27.945312 C 32.683594 27.929688 32.695312 27.917969 32.707031 27.898438 C 32.714844 27.886719 32.714844 27.875 32.71875 27.863281 C 34.089844 25.484375 34.878906 22.734375 34.878906 19.800781 C 34.878906 16.867188 34.089844 14.113281 32.71875 11.738281 Z M 32.71875 11.738281 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 13.375 7.800781 L 10.375 7.800781 C 9.714844 7.800781 9.175781 8.335938 9.175781 9 C 9.175781 9.664062 9.714844 10.199219 10.375 10.199219 L 13.375 10.199219 C 14.039062 10.199219 14.574219 9.664062 14.574219 9 C 14.574219 8.335938 14.039062 7.800781 13.375 7.800781 Z M 13.375 7.800781 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 13.375 12 L 7.375 12 C 6.714844 12 6.175781 12.539062 6.175781 13.199219 C 6.175781 13.863281 6.714844 14.398438 7.375 14.398438 L 13.375 14.398438 C 14.039062 14.398438 14.574219 13.863281 14.574219 13.199219 C 14.574219 12.539062 14.039062 12 13.375 12 Z M 13.375 12 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 13.375 16.199219 L 4.375 16.199219 C 3.714844 16.199219 3.175781 16.738281 3.175781 17.398438 C 3.175781 18.0625 3.714844 18.601562 4.375 18.601562 L 13.375 18.601562 C 14.039062 18.601562 14.574219 18.0625 14.574219 17.398438 C 14.574219 16.738281 14.039062 16.199219 13.375 16.199219 Z M 13.375 16.199219 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 13.375 20.398438 L 1.976562 20.398438 C 1.3125 20.398438 0.777344 20.9375 0.777344 21.601562 C 0.777344 22.261719 1.3125 22.800781 1.976562 22.800781 L 13.375 22.800781 C 14.039062 22.800781 14.574219 22.261719 14.574219 21.601562 C 14.574219 20.9375 14.039062 20.398438 13.375 20.398438 Z M 13.375 20.398438 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 13.375 24.601562 L 5.574219 24.601562 C 4.914062 24.601562 4.375 25.136719 4.375 25.800781 C 4.375 26.460938 4.914062 27 5.574219 27 L 13.375 27 C 14.039062 27 14.574219 26.460938 14.574219 25.800781 C 14.574219 25.136719 14.039062 24.601562 13.375 24.601562 Z M 13.375 24.601562 "/><path style=" stroke:none;fill-rule:nonzero;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 13.375 28.800781 L 9.175781 28.800781 C 8.511719 28.800781 7.976562 29.335938 7.976562 30 C 7.976562 30.664062 8.511719 31.199219 9.175781 31.199219 L 13.375 31.199219 C 14.039062 31.199219 14.574219 30.664062 14.574219 30 C 14.574219 29.335938 14.039062 28.800781 13.375 28.800781 Z M 13.375 28.800781 "/></g></svg>';

let videoId = null;
let videoTitle = null;

let uiInitialised = false;
let videoStream = null;
let popup = null;

console.log("Tubemark content.js started");
//In case we open up to a video page directly, we won't be informed of a URL
//change, so try to init the UI
initUiIfNecessary(window.location.href);

chrome.runtime.onMessage.addListener(
  function(request, sender, sendResponse) {
    if (request.message === 'ON_URL_CHANGE') {
      //In case we come from the Youtube homepage, in which case the video player
      //DOM hasn't been build yet, we need to wait for a URL change before we can
      //init our own UI.
      initUiIfNecessary(request.url);
    }
});

function initUiIfNecessary(url) {
  console.log("initUiIfNecessary", url);
  let newId = getVideoIdFromUrl(url);
  if (newId && newId != videoId) {
    videoId = newId;
    console.log("Looking at video:", videoId);
    if (!uiInitialised) {
      addInfoRequestListenerToWebPage();
      addBookmarkButton();
      initIFrame();
      uiInitialised = true;
      videoStream = document.getElementsByClassName("video-stream")[0];
      popup = document.getElementById("tubemark-menu");
    } else {
      closePopup()
    }
  }
}

function closePopup() {
  popup.style.display = 'none';
  document
    .getElementById("tubemark-iframe")
    .contentWindow
    .postMessage({ type: "CLOSE_POPUP" }, "*");
}

function addInfoRequestListenerToWebPage() {
  var s = document.createElement('script');
  s.type = "text/javascript";
  s.src = chrome.runtime.getURL('videoInfo.js');
  s.onload = function() {
      this.remove();
  };
  (document.head || document.documentElement).appendChild(s);
}

function addBookmarkButton() {
  var buttonWrapper = document.createElement("div");
  buttonWrapper.innerHTML = svgString.trim();

  var newBtn = document.createElement("button");
  newBtn.className = "ytp-fullscreen-button ytp-button";
  newBtn.title = "Bookmark";
  newBtn.append(buttonWrapper.firstChild);
  newBtn.onclick = function() {
    if (popup.style.display == 'block') {
      videoStream.play();
      closePopup();
    } else {
      window.postMessage({ type: "REQUEST_INFO" }, "*");
    }
  };
  document.getElementsByClassName("ytp-right-controls")[0].append(newBtn);
}

function initIFrame() {
  var popup = document.createElement("div");
  popup.id = "tubemark-menu";
  popup.style.cssText = `
    width:400px;
    height:500px;
    top:50px;
    right:20px;
    position: absolute;
    z-index: 2147483648 !important;
    background-color: #f1f1f1;
    text-align: center;
    border: 1px solid #d3d3d3;
    display: none;
  `;

  popup.innerHTML = `
    <iframe
      id="tubemark-iframe"
      src="${chrome.extension.getURL("mainPage.html")}"
      style="width:100%; height:100%; display:unset;"/>
  `;

  document.body.append(popup);
}

// listen for call from page
window.addEventListener("message", function(event) {
  // TODO the event.source cannot be accessed here without triggering a CSX
  // exception - need to check that out
  // We only accept messages from ourselves
  // if (event.source != window) return;
  switch (event?.data?.type) {
    case "CUR_VIDEO_INFO":
      popup.style.display = 'block';
      videoStream.pause();
      document.getElementById("tubemark-iframe").contentWindow.postMessage({
        type: "OPEN_POPUP",
        id: videoId,
        title: event.data.args.title,
        playbackTime: event.data.args.playbackTime
      }, "*");
    break;
    case "SKIP_TO_TIME":
      videoStream.currentTime = event.data.time;
      videoStream.play();
    break;
  }
}, false);

function getVideoIdFromUrl(url) {
  if (!url.includes("watch?v")) {
    return null;
  }

  var video_id = url.split("v=")[1];
  var ampersandPosition = video_id.indexOf("&");
  if (ampersandPosition != -1) {
    video_id = video_id.substring(0, ampersandPosition);
  }
  return video_id;
}
